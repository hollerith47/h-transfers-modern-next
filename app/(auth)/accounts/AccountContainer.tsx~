'use client';
import {useQuery} from '@tanstack/react-query';
import {useUser} from "@clerk/nextjs";
import {getAccountsByUser} from "@/app/actions";
import Link from "next/link";
import AccountItem from "@/components/AccountItem";
import Loader from "@/components/Loader";
import {Inbox} from "lucide-react";

export default function AccountContainer() {
    const {user} = useUser();
    const email = user?.primaryEmailAddress?.emailAddress;
    const {
        data: accounts = [],
        isLoading,
        isError,
    } = useQuery({
        queryKey: ['accounts', email],
        queryFn: async () => {
            if (!email) return [];
            // const toastId = toast.loading('Fetching accounts...');
            try {
                // toast.success('Accounts fetched successfully!', { id: toastId });
                return await getAccountsByUser({email});
            } catch (error) {
                console.error("error while fetching accounts", error);
                // toast.error('Failed to fetch accounts.', { id: toastId });
                throw error;
            }
        },
        enabled: !!email, // Important pour Ã©viter un appel sans email
    });

    if (isLoading) {
        // return <Loading />;
        return <Loader fullScreen size="xl" colorClass="text-primary"/>;
    }

    if (isError) {
        // TODO:: faire de composant pour l'erreur
        return <div>Failed to load accounts.</div>;
    }

    console.log(accounts)

    return (
        <>
            {accounts && accounts.length > 0 ? (
                <ul className="grid md:grid-cols-2 xl:grid-cols-3 gap-4 mt-5">
                    {accounts.map((account) => (
                        <li key={account.id}>
                            <Link href={`/manage/${account.id}`}>
                                <AccountItem account={account} />
                            </Link>
                        </li>
                    ))}
                </ul>
            ) : (
                <div className="flex flex-col w-full items-center justify-center p-8 text-gray-500">
                    <Inbox strokeWidth={1.5} className="w-12 h-12 mb-4" />
                    <p className="text-lg">Aucun compte disponible</p>
                </div>
            )}
        </>
    )
}
